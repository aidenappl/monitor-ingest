version: "3.8"

services:
  monitor-web:
    image: registry.appleby.cloud/monitor-web:latest
    container_name: monitor-web
    ports:
      - "3030:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      HOSTNAME: "0.0.0.0"
    restart: unless-stopped
    networks:
      - monitor-network
    healthcheck:
      test:
        - "CMD-SHELL"
        - "curl -f http://localhost:3000/api/health || exit 1"
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 45s
    depends_on:
      monitor-core:
        condition: service_healthy
    labels:
      - "com.docker.compose.project=monitor-web"
      - "traefik.enable=false"
  monitor-core:
    image: registry.appleby.cloud/monitor-core:latest
    container_name: monitor-core
    ports:
      - "8030:8080"
    environment:
      HTTP_PORT: "8080"
      CLICKHOUSE_ADDR: "clickhouse:9000"
      CLICKHOUSE_DATABASE: "monitor"
      CLICKHOUSE_USERNAME: ${CLICKHOUSE_USERNAME:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-}
      API_KEY: ${MONITOR_API_KEY}
      BATCH_SIZE: ${BATCH_SIZE:-1000}
      FLUSH_INTERVAL: ${FLUSH_INTERVAL:-5s}
      QUEUE_SIZE: ${QUEUE_SIZE:-100000}
    restart: unless-stopped
    networks:
      - monitor-network
    healthcheck:
      test:
        - "CMD-SHELL"
        - "curl -f http://localhost:8080/health || exit 1"
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      clickhouse:
        condition: service_healthy
    labels:
      - "com.docker.compose.project=monitor-core"
      - "traefik.enable=false"

  clickhouse:
    image: clickhouse/clickhouse-server:24.3-alpine
    container_name: monitor-clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    environment:
      CLICKHOUSE_DB: monitor
      CLICKHOUSE_USER: ${CLICKHOUSE_USERNAME:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - clickhouse-logs:/var/log/clickhouse-server
      - ./migrations:/docker-entrypoint-initdb.d:ro
    restart: unless-stopped
    networks:
      - monitor-network
    healthcheck:
      test:
        - "CMD-SHELL"
        - "clickhouse-client --query 'SELECT 1' || exit 1"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - "com.docker.compose.project=monitor-core"
      - "traefik.enable=false"
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

networks:
  monitor-network:
    driver: bridge

volumes:
  clickhouse-data:
  clickhouse-logs:
